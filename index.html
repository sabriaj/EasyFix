<!DOCTYPE html>
<html lang="sq" class="scroll-smooth">
<head>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CWDYCJ09D8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CWDYCJ09D8');
</script>



  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyFix - Kërko Mjeshtra Profesionalë</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- i18n (NEW) - duhet me qenë NON-defer se ke inline script poshtë -->
  <script src="i18n.js"></script>

  <!-- logo per tabs -->
  <link rel="icon" href="easyfix-icons-pack/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="easyfix-icons-pack/favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="easyfix-icons-pack/favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="easyfix-icons-pack/apple-touch-icon.png">
  <meta name="theme-color" content="#1d4ed8">
  <!-- /logo per tabs -->

  <style>
    .badge-premium { background: linear-gradient(to right, #fbbf24, #f59e0b); color: black; }
    .badge-standard { background: #3b82f6; color: white; }
    .badge-basic { background: #6b7280; color: white; }

    #photoModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88);
      justify-content: center; align-items: center; z-index: 9999; padding: 24px; }
    #photoModal .modal-card { width: min(1100px, 95vw); height: min(720px, 92vh);
      display: flex; flex-direction: column; gap: 12px; }
    #photoModal .modal-img-wrap { position: relative; flex: 1; display: flex;
      justify-content: center; align-items: center; border-radius: 14px; overflow: hidden;
      background: rgba(255,255,255,0.06); box-shadow: 0 0 24px rgba(0,0,0,0.35); }
    #photoModal img { max-width: 100%; max-height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none; }
    #photoModal .modal-actions { display: flex; justify-content: space-between; align-items: center; color: white; gap: 12px; }
    .modal-btn { background: rgba(255,255,255,0.14); border: 1px solid rgba(255,255,255,0.18);
      padding: 10px 12px; border-radius: 10px; font-weight: 700; transition: transform .08s ease, background .15s ease; }
    .modal-btn:hover { background: rgba(255,255,255,0.20); }
    .modal-btn:active { transform: scale(0.98); }
    .modal-close { background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.16);
      padding: 8px 10px; border-radius: 10px; font-weight: 800; }
    .focus-ring { outline: 3px solid rgba(37,99,235,0.9); outline-offset: 2px; box-shadow: 0 0 0 6px rgba(37,99,235,0.12); }

    .skeleton {
      background: linear-gradient(90deg, rgba(0,0,0,.03), rgba(0,0,0,.08), rgba(0,0,0,.03));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite;
      border-radius: 14px;
      height: 160px;
    }
    @keyframes shimmer {
      0% { background-position: 0% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header (responsive për mobile) -->
  <header class="bg-blue-700 text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-extrabold tracking-tight">EasyFix</h1>
        <span id="countryPill" class="hidden text-xs font-bold bg-white/20 px-2 py-1 rounded-full"></span>

        <!-- Language Dropdown (ONLY here) -->
        <div class="relative ml-1" id="langDropdown">
          <button
            id="langBtn"
            type="button"
            class="flex items-center gap-2 text-xs sm:text-sm font-bold bg-white/15 hover:bg-white/25 px-3 py-2 rounded-lg"
            aria-haspopup="true"
            aria-expanded="false"
            title="Language"
          >
            <span id="langFlag" class="inline-flex items-center">
              <img id="langFlagImg" alt="" class="w-5 h-5 rounded-sm shadow-sm" />
            </span>
            <span id="langLabel" class="hidden sm:inline">Shqip</span>
            <svg class="w-4 h-4 opacity-90" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.17l3.71-3.94a.75.75 0 1 1 1.08 1.04l-4.24 4.5a.75.75 0 0 1-1.08 0l-4.24-4.5a.75.75 0 0 1 .02-1.06z" clip-rule="evenodd"/>
            </svg>
          </button>

          <div
            id="langMenu"
            class="hidden absolute left-0 mt-2 w-48 rounded-xl bg-white text-gray-900 shadow-lg ring-1 ring-black/10 overflow-hidden z-50"
            role="menu"
            aria-label="Language menu"
          >
            <button type="button" data-lang="sq" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-left" role="menuitem">
              <img data-flag="sq" alt="" class="w-5 h-5 rounded-sm shadow-sm" />
              <span class="font-semibold">Shqip</span>
            </button>
            <button type="button" data-lang="mk" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-left" role="menuitem">
              <img data-flag="mk" alt="" class="w-5 h-5 rounded-sm shadow-sm" />
              <span class="font-semibold">Македонски</span>
            </button>
            <button type="button" data-lang="en" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 text-left" role="menuitem">
              <img data-flag="en" alt="" class="w-5 h-5 rounded-sm shadow-sm" />
              <span class="font-semibold">English</span>
            </button>
          </div>
        </div>
      </div>

      <nav class="flex flex-wrap gap-2 sm:gap-4">
        <a href="register.html"
           data-i18n="nav_register"
           class="bg-white/15 hover:bg-white/20 px-4 py-2 rounded-lg font-semibold text-sm sm:text-base">
          Regjistro Firmën
        </a>
        <a href="contact.html"
           data-i18n="nav_contact"
           class="bg-white/15 hover:bg-white/20 px-4 py-2 rounded-lg font-semibold text-sm sm:text-base">
          Kontakt
        </a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-10 flex-grow">
    <h2 class="text-4xl font-bold text-blue-900 mb-8 text-center" data-i18n="hero">
      Gjej mjeshtrin që të duhet me shpejtësi
    </h2>

    <section class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">

      <!-- Status / errors -->
      <div id="topStatus" class="hidden mb-5"></div>

      <div class="flex flex-col md:flex-row md:space-x-6 mb-6">
        <input
          id="searchInput"
          type="text"
          data-i18n-placeholder="search_placeholder"
          placeholder="Kërko firmë ose shërbim..."
          class="flex-grow border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 md:mb-0"
        />

        <select
          id="categorySelect"
          class="border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="" data-i18n="all_categories">Të gjitha kategoritë</option>
        </select>
      </div>

      <!-- Loading skeleton -->
      <div id="loadingGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <!-- Data -->
      <div id="firmsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden"></div>

      <p id="noResults" class="text-center text-gray-500 mt-4 hidden" data-i18n="no_results">
        Nuk u gjetën firma për kriteret e kërkimit.
      </p>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-blue-700 text-white text-center py-6 mt-auto">
    <!-- Links moved to bottom -->
    <div class="text-sm opacity-95 mb-2 flex items-center justify-center gap-2 flex-wrap">
      <a class="underline hover:opacity-90" href="privacy.html">Privacy Policy</a>
      <span class="opacity-80">•</span>
      <a class="underline hover:opacity-90" href="delete.html">Data Deletion</a>
    </div>

    <div data-i18n="footer">
      &copy; 2025 EasyFix.services - Ndihma për çdo shtëpi
    </div>
  </footer>

  <!-- MODAL -->
  <div id="photoModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-actions">
        <div class="text-sm opacity-90">
          <span id="modalTitle" class="font-semibold"></span>
          <span id="modalCounter" class="ml-2 opacity-80"></span>
        </div>
        <button class="modal-close" id="modalCloseBtn" type="button" data-i18n="close">Mbyll</button>
      </div>

      <div class="modal-img-wrap" id="modalBackdrop">
        <button class="modal-btn absolute left-3 top-1/2 -translate-y-1/2" id="modalPrevBtn" type="button">‹</button>
        <img id="modalImage" src="" alt="Foto" />
        <button class="modal-btn absolute right-3 top-1/2 -translate-y-1/2" id="modalNextBtn" type="button">›</button>
      </div>

      <div class="modal-actions">
        <button class="modal-btn" id="modalPrevBtn2" type="button" data-i18n="prev">Prev</button>
        <div class="text-xs opacity-80" data-i18n="modal_help">Esc për me mbyll, shigjeta ← → për Next/Prev</div>
        <button class="modal-btn" id="modalNextBtn2" type="button" data-i18n="next">Next</button>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://easyfix.onrender.com";
let allFirms = [];

const categorySelect = document.getElementById("categorySelect");
const searchInput = document.getElementById("searchInput");
const firmsContainer = document.getElementById("firmsContainer");
const noResults = document.getElementById("noResults");
const countryPill = document.getElementById("countryPill");
const topStatus = document.getElementById("topStatus");
const loadingGrid = document.getElementById("loadingGrid");

// i18n (NEW)
const { getLang, setLang, t, applyTranslations, normalizeCategoryKey, categoryLabel } = window.EASYFIX_I18N;

/* ===== language dropdown (ONLY index) ===== */
const langBtn = document.getElementById("langBtn");
const langMenu = document.getElementById("langMenu");
const langLabel = document.getElementById("langLabel");
const langFlagImg = document.getElementById("langFlagImg");

const LANG_META = {
  sq: { flagUrl: "https://flagcdn.com/w40/al.png", label: "Shqip" },
  mk: { flagUrl: "https://flagcdn.com/w40/mk.png", label: "Македонски" },
  en: { flagUrl: "https://flagcdn.com/w40/gb.png", label: "English" },
};

function renderLangUI() {
  const current = (getLang && getLang()) ? getLang() : "sq";
  const meta = LANG_META[current] || LANG_META.sq;

  if (langFlagImg) {
    langFlagImg.src = meta.flagUrl;
    langFlagImg.alt = current.toUpperCase();
    langFlagImg.referrerPolicy = "no-referrer";
  }

  document.querySelectorAll("#langMenu img[data-flag]").forEach(img => {
    const code = img.getAttribute("data-flag");
    const m = LANG_META[code];
    if (!m) return;
    img.src = m.flagUrl;
    img.alt = code.toUpperCase();
    img.referrerPolicy = "no-referrer";
  });

  if (langLabel) langLabel.textContent = meta.label;
}

function openLangMenu() {
  if (!langMenu) return;
  langMenu.classList.remove("hidden");
  langBtn?.setAttribute("aria-expanded", "true");
}

function closeLangMenu() {
  if (!langMenu) return;
  langMenu.classList.add("hidden");
  langBtn?.setAttribute("aria-expanded", "false");
}

function toggleLangMenu() {
  if (!langMenu) return;
  const isOpen = !langMenu.classList.contains("hidden");
  if (isOpen) closeLangMenu();
  else openLangMenu();
}

langBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  toggleLangMenu();
});

langMenu?.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-lang]");
  if (!btn) return;
  const lang = btn.getAttribute("data-lang") || "sq";

  setLang(lang);
  applyTranslations();
  renderLangUI();

  populateCategoryFilter(allFirms);
  filterFirms();

  closeLangMenu();
});

document.addEventListener("click", () => closeLangMenu());
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeLangMenu();
});

/* ===== helpers ===== */
function sanitize(text) { return text ? text.toString().trim() : ""; }
function normalizeEmail(email) { return sanitize(email).toLowerCase(); }
function phoneToTelHref(phone) { const p = sanitize(phone).replace(/[^\d+]/g, ""); return p || ""; }
function clampPhotos(firm) {
  const photos = Array.isArray(firm.photos) ? firm.photos : [];
  const plan = (firm.plan || "").toLowerCase();
  if (plan === "standard") return photos.slice(0, 3);
  if (plan === "premium") return photos.slice(0, 8);
  return [];
}

function setLoading(isLoading) {
  if (isLoading) {
    loadingGrid.classList.remove("hidden");
    firmsContainer.classList.add("hidden");
  } else {
    loadingGrid.classList.add("hidden");
    firmsContainer.classList.remove("hidden");
  }
}

function showTopStatus(kind, title, desc, withRetry=false) {
  topStatus.classList.remove("hidden");

  const base = "rounded-xl border p-4 flex flex-col gap-2";
  const styles =
    kind === "error" ? "bg-red-50 text-red-700 border-red-200"
    : kind === "success" ? "bg-green-50 text-green-700 border-green-200"
    : "bg-blue-50 text-blue-700 border-blue-200";

  topStatus.className = `${base} ${styles}`;

  topStatus.innerHTML = `
    <div class="font-bold">${sanitize(title)}</div>
    <div class="text-sm opacity-90">${sanitize(desc || "")}</div>
    ${withRetry ? `<div class="pt-2">
      <button id="retryBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg">
        ${t("retry")}
      </button>
    </div>` : ""}
  `;

  if (withRetry) {
    const btn = document.getElementById("retryBtn");
    if (btn) btn.onclick = () => loadFirms();
  }
}

function clearTopStatus() {
  topStatus.classList.add("hidden");
  topStatus.innerHTML = "";
}

async function detectUserCountryCode() {
  try {
    const r = await fetch("https://ipapi.co/json/");
    const j = await r.json();
    const code = (j?.country_code || "MK").toUpperCase();
    return (code && code.length === 2) ? code : "MK";
  } catch { return "MK"; }
}

/* ===== categories ===== */
function populateCategoryFilter(firms) {
  categorySelect.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = t("all_categories");
  categorySelect.appendChild(optAll);

  const keys = [...new Set(firms.map(f => f._catKey))].sort((a,b) => categoryLabel(a).localeCompare(categoryLabel(b)));
  keys.forEach(k => {
    if (!k) return;
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = categoryLabel(k);
    categorySelect.appendChild(opt);
  });
}

/* ===== modal slider ===== */
const photoModal = document.getElementById("photoModal");
const modalImage = document.getElementById("modalImage");
const modalTitle = document.getElementById("modalTitle");
const modalCounter = document.getElementById("modalCounter");
const modalBackdrop = document.getElementById("modalBackdrop");

const modalCloseBtn = document.getElementById("modalCloseBtn");
const modalPrevBtn = document.getElementById("modalPrevBtn");
const modalNextBtn = document.getElementById("modalNextBtn");
const modalPrevBtn2 = document.getElementById("modalPrevBtn2");
const modalNextBtn2 = document.getElementById("modalNextBtn2");

let modalPhotos = [];
let modalIndex = 0;

function openModalSlider({ photos, startIndex, firmName }) {
  modalPhotos = photos || [];
  modalIndex = Math.max(0, Math.min(startIndex || 0, modalPhotos.length - 1));

  modalTitle.textContent = firmName ? sanitize(firmName) : "";
  updateModalImage();
  photoModal.style.display = "flex";
  photoModal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function updateModalImage() {
  if (!modalPhotos.length) return;
  modalImage.src = modalPhotos[modalIndex];
  modalCounter.textContent = `(${modalIndex + 1}/${modalPhotos.length})`;
}
function closeModal() {
  photoModal.style.display = "none";
  photoModal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  modalPhotos = [];
  modalIndex = 0;
}
function modalPrev() {
  if (!modalPhotos.length) return;
  modalIndex = (modalIndex - 1 + modalPhotos.length) % modalPhotos.length;
  updateModalImage();
}
function modalNext() {
  if (!modalPhotos.length) return;
  modalIndex = (modalIndex + 1) % modalPhotos.length;
  updateModalImage();
}

modalCloseBtn.addEventListener("click", closeModal);
modalPrevBtn.addEventListener("click", modalPrev);
modalNextBtn.addEventListener("click", modalNext);
modalPrevBtn2.addEventListener("click", modalPrev);
modalNextBtn2.addEventListener("click", modalNext);

photoModal.addEventListener("click", (e) => { if (e.target === photoModal) closeModal(); });
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

document.addEventListener("keydown", (e) => {
  if (photoModal.style.display !== "flex") return;
  if (e.key === "Escape") closeModal();
  if (e.key === "ArrowLeft") modalPrev();
  if (e.key === "ArrowRight") modalNext();
});

/* ===== autoplay premium ===== */
const autoplayTimers = new Map();
function startAutoplay(containerEl, photos) {
  stopAutoplay(containerEl);
  if (!photos || photos.length <= 1) return;

  let i = 0;
  const imgEl = containerEl.querySelector("img[data-main-photo='1']");
  const dots = Array.from(containerEl.querySelectorAll("[data-dot]"));

  const tick = () => {
    i = (i + 1) % photos.length;
    if (imgEl) imgEl.src = photos[i];
    dots.forEach((d, idx) => {
      d.className = idx === i ? "w-2 h-2 rounded-full bg-blue-600" : "w-2 h-2 rounded-full bg-gray-300";
    });
  };

  const tmr = setInterval(tick, 5000);
  autoplayTimers.set(containerEl, tmr);
}
function stopAutoplay(containerEl) {
  const tmr = autoplayTimers.get(containerEl);
  if (tmr) clearInterval(tmr);
  autoplayTimers.delete(containerEl);
}

/* ===== render ===== */
function renderFirms(firms) {
  autoplayTimers.forEach((tmr) => clearInterval(tmr));
  autoplayTimers.clear();

  firmsContainer.innerHTML = "";

  if (!firms.length) {
    noResults.classList.remove("hidden");
    return;
  } else {
    noResults.classList.add("hidden");
  }

  firms.forEach((firm) => {
    const div = document.createElement("div");
    div.className = "border border-gray-300 rounded-xl p-5 shadow bg-white hover:shadow-md transition";
    div.dataset.email = normalizeEmail(firm.email);

    const plan = (firm.plan || "basic").toLowerCase();
    const showMedia = plan !== "basic";
    const logo = showMedia ? (firm.logoUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png") : null;
    const photos = showMedia ? clampPhotos(firm) : [];

    const tel = phoneToTelHref(firm.phone);
    const hasTel = !!tel;

    const badgeHTML =
      plan === "premium"
        ? `<span class="badge-premium px-3 py-1 rounded-full text-xs font-bold">Premium</span>`
        : plan === "standard"
          ? `<span class="badge-standard px-3 py-1 rounded-full text-xs font-bold">Standard</span>`
          : `<span class="badge-basic px-3 py-1 rounded-full text-xs font-bold">Basic</span>`;

    const headerHTML = showMedia
      ? `
        <div class="flex items-center mb-3">
          <img src="${logo}" class="w-14 h-14 rounded-full object-cover border shadow-sm mr-3" />
          <div>
            <h3 class="text-xl font-bold text-blue-700">${sanitize(firm.name)}</h3>
            ${badgeHTML}
          </div>
        </div>
      `
      : `
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-xl font-bold text-blue-700">${sanitize(firm.name)}</h3>
            ${badgeHTML}
          </div>
        </div>
      `;

    let photosHTML = "";
    if (photos.length > 0) {
      photosHTML = `
        <div class="mt-4" data-slider="1">
          <div class="rounded-xl overflow-hidden border bg-gray-50">
            <img src="${photos[0]}" data-main-photo="1" class="w-full h-48 object-cover cursor-pointer" alt="Foto e shërbimeve" />
          </div>

          <div class="flex items-center justify-between mt-2">
            <div class="flex gap-1">
              ${photos.map((_, i) => `
                <span data-dot="${i}" class="${i === 0 ? "w-2 h-2 rounded-full bg-blue-600" : "w-2 h-2 rounded-full bg-gray-300"}"></span>
              `).join("")}
            </div>
            <div class="text-xs text-gray-500">${photos.length} ${t("photos")}</div>
          </div>

          <div class="flex space-x-2 mt-3 overflow-x-auto pb-1">
            ${photos.map((p, i) => `
              <img src="${p}" data-thumb-index="${i}" class="w-20 h-20 object-cover rounded-lg cursor-pointer shadow-sm border" alt="Foto ${i+1}" />
            `).join("")}
          </div>
        </div>
      `;
    }

    const phoneLine = hasTel
      ? `
        <p><strong>${t("phone")}:</strong>
          <a href="tel:${tel}" class="text-blue-700 underline font-semibold">${sanitize(firm.phone)}</a>
        </p>
      `
      : `<p><strong>${t("phone")}:</strong> <span class="text-gray-500">${t("not_set")}</span></p>`;

    const callButtons = hasTel
      ? `
        <div class="mt-3 grid grid-cols-2 gap-2">
          <a href="tel:${tel}" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold">${t("call")}</a>
          <a href="sms:${tel}" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold">${t("sms")}</a>
        </div>
      `
      : "";

    div.innerHTML = `
      ${headerHTML}
      <p><strong>${t("address")}:</strong> ${sanitize(firm.address)}</p>
      ${phoneLine}
      <p><strong>${t("email")}:</strong>
        <a href="mailto:${sanitize(firm.email)}" class="text-blue-600 underline">${sanitize(firm.email)}</a>
      </p>
      <p><strong>${t("category")}:</strong> ${categoryLabel(firm._catKey)}</p>
      <p class="text-xs text-gray-500 mt-1"><strong>${t("country")}:</strong> ${sanitize(firm.country || "MK")}</p>
      ${callButtons}
      ${photosHTML}
    `;

    if (photos.length > 0) {
      const slider = div.querySelector("[data-slider='1']");
      const mainImg = slider.querySelector("img[data-main-photo='1']");
      const thumbs = Array.from(slider.querySelectorAll("[data-thumb-index]"));
      const dots = Array.from(slider.querySelectorAll("[data-dot]"));

      let currentIndex = 0;

      function setIndex(i) {
        currentIndex = i;
        mainImg.src = photos[currentIndex];
        dots.forEach((d, idx) => {
          d.className = idx === currentIndex ? "w-2 h-2 rounded-full bg-blue-600" : "w-2 h-2 rounded-full bg-gray-300";
        });
      }

      mainImg.addEventListener("click", () => openModalSlider({ photos, startIndex: currentIndex, firmName: firm.name }));

      thumbs.forEach(t => {
        t.addEventListener("click", () => {
          const i = Number(t.getAttribute("data-thumb-index") || "0");
          setIndex(i);
          openModalSlider({ photos, startIndex: i, firmName: firm.name });
        });
      });

      if (plan === "premium") startAutoplay(slider, photos);
    }

    firmsContainer.appendChild(div);
  });
}

/* ===== filter ===== */
function filterFirms() {
  const txt = searchInput.value.toLowerCase();
  const cat = categorySelect.value;

  const filtered = allFirms.filter(f => {
    const matchName = sanitize(f.name).toLowerCase().includes(txt);
    const matchCat = !cat || String(f._catKey) === String(cat);
    return matchName && matchCat;
  });

  renderFirms(filtered);
}

/* ===== focus from URL ===== */
function focusFirmFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const focus = normalizeEmail(params.get("focus") || "");
  if (!focus) return;

  const el = firmsContainer.querySelector(`[data-email="${focus.replace(/"/g, '\\"')}"]`);
  if (!el) return;

  el.classList.add("focus-ring");
  el.scrollIntoView({ behavior: "smooth", block: "center" });
  setTimeout(() => el.classList.remove("focus-ring"), 6000);
}

/* ===== fetch with retry ===== */
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function fetchFirmsWithRetry(country, attempts = 4) {
  let lastErr = null;
  for (let i = 1; i <= attempts; i++) {
    try {
      const url = `${API_URL}/firms?country=${encodeURIComponent(country)}&t=${Date.now()}`;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      if (!Array.isArray(data)) throw new Error("Invalid response");
      return data;
    } catch (e) {
      lastErr = e;
      await sleep(700 * i);
    }
  }
  throw lastErr || new Error("Fetch failed");
}

async function loadFirms() {
  clearTopStatus();
  setLoading(true);

  const params = new URLSearchParams(window.location.search);
  const urlCountry = (params.get("country") || "").toUpperCase();
  const country = (/^[A-Z]{2}$/.test(urlCountry)) ? urlCountry : await detectUserCountryCode();

  countryPill.textContent = country;
  countryPill.classList.remove("hidden");

  try {
    const data = await fetchFirmsWithRetry(country, 5);

    allFirms = (data || []).map(f => {
      f._catKey = normalizeCategoryKey(f.category);
      return f;
    }).sort((a, b) => {
      const order = { premium: 1, standard: 2, basic: 3 };
      return (order[(a.plan || "").toLowerCase()] || 9) - (order[(b.plan || "").toLowerCase()] || 9);
    });

    populateCategoryFilter(allFirms);
    renderFirms(allFirms);

    setLoading(false);

    // ✅ FIX: focus after content is visible (mobile safe)
    requestAnimationFrame(() => {
      setTimeout(() => focusFirmFromUrl(), 60);
    });

  } catch (err) {
    console.error("Gabim:", err);
    setLoading(false);
    showTopStatus("error", t("load_fail_title"), t("load_fail_hint"), true);
  }
}

/* ===== init ===== */
applyTranslations();
renderLangUI();
closeLangMenu();

loadFirms();
searchInput.addEventListener("input", filterFirms);
categorySelect.addEventListener("change", filterFirms);
</script>

</body>
</html>
