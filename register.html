<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyFix - Regjistro dhe Abono</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 flex flex-col items-center min-h-screen">

  <h1 class="text-3xl font-bold mb-6">Regjistro Firmën dhe Zgjidh Planin</h1>

  <form id="firmForm" class="bg-white p-6 rounded shadow-md w-full max-w-md">
    <input type="text" name="emri" placeholder="Emri i firmës" required class="w-full mb-3 p-2 border rounded" />
    <input type="text" name="adresa" placeholder="Adresa / Qyteti" required class="w-full mb-3 p-2 border rounded" />
    <input type="tel" name="telefoni" placeholder="Numër telefoni" required class="w-full mb-3 p-2 border rounded" />
    <input type="email" name="email" placeholder="Email" required class="w-full mb-3 p-2 border rounded" />
    <input type="text" name="kategoria" placeholder="Kategoria (p.sh. Elektricist)" required class="w-full mb-3 p-2 border rounded" />

    <p class="mb-3 font-semibold">Zgjidh planin e abonimit (e detyrueshme):</p>

    <!-- BUTONA KATROR (jo të rrumbullakët) -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button type="button"
              class="planBtn px-4 py-3 border rounded-md font-medium hover:bg-green-50"
              data-plan="mujor"
              data-url="https://buy.stripe.com/test_6oUaEP63Q2Ci1ak0bn0Ba00">
        Plan Mujor $20
      </button>

      <button type="button"
              class="planBtn px-4 py-3 border rounded-md font-medium hover:bg-blue-50"
              data-plan="vjetor"
              data-url="https://buy.stripe.com/test_5kQ28j4ZM3Gm7yI2jv0Ba01">
        Plan Vjetor $200
      </button>
    </div>

    <input type="hidden" id="selectedPlan" name="plan" required />

    <button type="submit" id="submitBtn"
            class="bg-blue-600 text-white py-2 rounded w-full hover:bg-blue-700 transition">
      Regjistrohu
    </button>

    <p id="status" class="mt-4 text-center font-semibold"></p>
  </form>

<script>
  // ⚠️ VENDOSE URL-n E WEB APP (Apps Script) KËTU:
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyr4yTkW3qAYXdOkATQrIL2XAsXco7PyOZL3t8LgoOiEGBXOvEwI6izIh_ZAcVMJotZ/exec';

  // Stilizim & përzgjedhje plani
  const planBtns = document.querySelectorAll('.planBtn');
  const selectedPlanInput = document.getElementById('selectedPlan');
  planBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      planBtns.forEach(b => b.classList.remove('ring-2','ring-yellow-400','bg-yellow-50'));
      btn.classList.add('ring-2','ring-yellow-400','bg-yellow-50');
      selectedPlanInput.value = btn.dataset.plan;
    });
  });

  const form = document.getElementById('firmForm');
  const statusEl = document.getElementById('status');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!selectedPlanInput.value) {
      statusEl.textContent = 'Ju lutem zgjidhni një plan.';
      statusEl.style.color = 'red';
      return;
    }

    statusEl.textContent = 'Duke regjistruar...';
    statusEl.style.color = 'black';

    const fd = new FormData(form);
    const payload = {};
    fd.forEach((v,k) => payload[k] = String(v).trim());

    try {
      // Shmang CORS preflight -> text/plain
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const json = await res.json().catch(()=>null);

      if (res.ok && json && json.status === 'success') {
        statusEl.textContent = 'U regjistruat me sukses! Po ju dërgojmë për pagesë...';
        statusEl.style.color = 'green';

        const chosen = document.querySelector('.planBtn.ring-yellow-400');
        const stripeUrl = chosen ? chosen.dataset.url : null;

        setTimeout(() => {
          if (stripeUrl) window.location.href = stripeUrl;
        }, 1200);
      } else {
        statusEl.textContent = 'Dështoi regjistrimi: ' + (json && json.message ? json.message : 'provo përsëri.');
        statusEl.style.color = 'red';
        console.error('Server response:', json);
      }
    } catch (err) {
      statusEl.textContent = 'Gabim gjatë regjistrimit. Provo përsëri.';
      statusEl.style.color = 'red';
      console.error(err);
    }
  });
</script>

</body>
</html>
